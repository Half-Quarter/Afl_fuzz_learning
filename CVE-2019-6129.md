#CVE-2019-6129复现

##资料链接：
 http://www.libpng.org/pub/png/libpng.html
 https://ftp-osl.osuosl.org/pub/libpng/src/

##软件简介：
  libpng是一款C语言编写的比较底层的读写PNG文件的跨平台的库，全称是可携式网络图像（portable network graphics），
借助它可以轻松读写PNG文件的每一行像素。因为PNG文件是经过压缩而且格式复杂的图形文件（有的PNG文件甚至像GIF文件一样带动画效果，但是不像jpg那样是有损压缩，png是无损压缩的），
而且PNG可以是带透明通道的真彩色图像、不带透明通道的真彩色图像、索引颜色、灰度颜色等各种格式，如果大家都自己写程序分析PNG文件就会显得很麻烦、很累。
因此，通过使用libpng你就能直接使用现成的函数、程序来读写PNG文件了。
我这里使用的版本是libpng-1.5.4
 
##漏洞点代码：
libpng/png.c第352到376行代码
```
 /* 为应用程序分配内存 */ 
 PNG_FUNCTION(png_infop,PNGAPI 
 png_create_info_struct,(png_const_structrp png_ptr),PNG_ALLOCATED) 
 { 
    png_inforp info_ptr; 
  
    png_debug(1, "in png_create_info_struct"); 
  
    if (png_ptr == NULL) 
       return NULL; 
  
    info_ptr = png_voidcast(png_inforp, png_malloc_base(png_ptr, 
        (sizeof *info_ptr))); 
  
    if (info_ptr != NULL) 
       memset(info_ptr, 0, (sizeof *info_ptr)); 
  
    return info_ptr; 
 } 
```

##漏洞分析：
 用asan调试能发现内存泄漏的问题，泄露了360字节
```
   $ pngcp libpng_poc /dev/null
libpng_poc: error(libpng): read: Not a PNG file

=================================================================
==30270==ERROR: LeakSanitizer: detected memory leaks

Direct leak of 360 byte(s) in 1 object(s) allocated from:
    #0 0x7f07e0ecced0 in malloc (/usr/lib64/libasan.so.5+0xebed0)
    #1 0x7f07e1d3c23f in png_malloc_base /usr/src/debug/libpng16-1.6.36-0.x86_64/pngmem.c:95
    #2 0x7f07e1d24d55 in png_create_info_struct /usr/src/debug/libpng16-1.6.36-0.x86_64/png.c:368
    #3 0x55806e30a07b in read_png contrib/tools/pngcp.c:1775
    #4 0x55806e30d0b1 in cp_one_file contrib/tools/pngcp.c:2180
    #5 0x55806e30dba4 in cppng contrib/tools/pngcp.c:2288
    #6 0x55806e30e081 in main contrib/tools/pngcp.c:2351
    #7 0x7f07e0a43fea in __libc_start_main (/lib64/libc.so.6+0x22fea)

SUMMARY: AddressSanitizer: 360 byte(s) leaked in 1 allocation(s).
```
 目前还没有补丁解决这个问题

##poc分析：
https://github.com/glennrp/libpng/files/2729282/libpng_poc.zip